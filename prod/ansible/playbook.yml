---
- name: Update and upgrade Ubuntu packages locally
  hosts: localhost
  connection: local
  become: yes
  gather_facts: no  # Disable gathering facts
  tasks:
    - name: Update package cache
      apt:
        update_cache: yes

    - name: Upgrade all packages
      apt:
        upgrade: dist
    
    - name: Install packages
      apt:
        name:
          - docker
          - docker-compose
        state: present
    
    - name: Disable Docker service from starting at boot
      systemd:
        name: docker
        enabled: no

    - name: Check if the flag file exists
      stat:
        path: /ansible/ansible_first_run.flag
      register: flag_file

    # - name: Perform tasks for the first run
    #   debug:
    #     msg: "This is the first Ansible run"
    #   when: flag_file.stat.exists == false
    - name: Create directory recursively
      file:
        path: /mnt/data
        state: directory
        recurse: yes

    - name: Set permissions and ownership on the mount point directory
      file:
        path: /mnt/data  
        owner: skylord  
        group: skylord  
        mode: "0777"  
    - name: Create directory /opt/dockge
      file:
        path: /opt/dockge
        state: directory
        owner: skylord  
        group: skylord  
        mode: "0755"  

    - name: Download compose.yaml file
      get_url:
        url: "https://dockge.kuma.pet/compose.yaml?port=5001&stacksPath=/mnt/data/docker/compose"
        dest: /tmp/compose.yaml
      when: flag_file.stat.exists == false

    - name: Create the flag file
      file:
        path: /ansible/ansible_first_run.flag
        state: touch
      when: flag_file.stat.exists == false

    - name: Start Docker service
      systemd:
        name: docker
        state: started
    
