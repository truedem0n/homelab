#!/usr/bin/env python3
import os
import subprocess

WG_CONFIG = "/etc/wireguard/wg0.conf"
CLIENTS_DIR = "./clients"

def run_cmd(cmd):
    return subprocess.check_output(cmd, shell=True).decode().strip()

def generate_keys(name):
    private_key = run_cmd("wg genkey")
    public_key = run_cmd(f"echo '{private_key}' | wg pubkey")
    return private_key, public_key

def add_peer(name, ip):
    print(f"🔑 Generating keys for {name}...")
    priv, pub = generate_keys(name)
    client_ip = f"10.8.0.{ip}/32"

    # Append peer to server config
    peer_conf = f"""
[Peer]
# {name}
PublicKey = {pub}
AllowedIPs = {client_ip}
"""
    with open(WG_CONFIG, "a") as f:
        f.write(peer_conf)

    print("✅ Peer added to server config.")

    # Generate client config
    server_pub = open("/etc/wireguard/publickey").read().strip()
    client_conf = f"""
[Interface]
PrivateKey = {priv}
Address = {client_ip}
DNS = 1.1.1.1

[Peer]
PublicKey = {server_pub}
Endpoint = <YOUR_SERVER_IP>:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
"""
    os.makedirs(CLIENTS_DIR, exist_ok=True)
    with open(f"{CLIENTS_DIR}/{name}.conf", "w") as f:
        f.write(client_conf.strip())

    print(f"📁 Client config saved: {CLIENTS_DIR}/{name}.conf")
    print("🔁 Restarting WireGuard...")
    os.system("systemctl restart wg-quick@wg0")
    print("✅ Done.")

if __name__ == "__main__":
    name = input("Enter peer name (no spaces): ").strip()
    ip = input("Enter last octet of IP (e.g. 2 for 10.8.0.2): ").strip()
    add_peer(name, ip)
